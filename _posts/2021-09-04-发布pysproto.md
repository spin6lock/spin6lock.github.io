---
layout:     post
title:      "发布pysproto"
subtitle:   ""
date:       2021-09-04
author:     "spin6lock"
catalog:    true
tags:
- pysproto
- python
- sproto
- pypi
- setuptools
---
今天是个值得纪念的日子，我终于将适用于Python 3.0的pysproto成功上传到pypi了，顺便写一篇博客吐槽下Python的打包发布系统

依稀记得之前将C文件都放在src目录里，结果死活编译不过，于是都散装放在根目录了；然后Pypi要先发布测试包，再在网页操作一下，发布成正式包。setup.py作为包的描述文件，long_description字段还得用reStructure Text的格式写，不然就提交不过。pysproto这个模块需要头文件，但是屡屡打包都没打进去。感觉打包模块在这里是broken的，[有个stackoverflow](https://stackoverflow.com/a/35400299)的回答精确描述了我的感受: 在sources字段列举头文件会导致无法编译，distutil不能区分.h文件，会试图编译对应的.o文件；在headers字段列举头文件会被忽略；在setup函数的headers字段里列举头文件能识别，但是不会被打进包里；在Extension函数的include_dirs里列举头文件，也不会打进包里。最后还是用了最高赞答案的MANIFEST.in文件里写一行`graft 头文件路径`, 终于解决问题。。。

要测试打包是否工作，可以试试用`python3 -m build`来测试，需要安装venv和build模块。这个命令会新建一个虚拟环境，然后打包成源码，再在虚拟环境里编译安装源码。不过最后还是真机测试了一下，修正了Python.h头文件写死绝对路径的问题。。。

还有一个奇怪的点，pypi的网页版不支持直接新建项目，新建token的时候却要选择项目。于是，被迫在~/.pypi里新建一个高权限的token，将包上传上去，建立一个项目，再删掉token，新建项目专用token，相当别扭。。。而且为啥上传包居然是用twine，不是用setuptools？

好吧，从2017年到2021年，总算将包上传上去了。。。

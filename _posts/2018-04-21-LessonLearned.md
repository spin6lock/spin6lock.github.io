---
layout:     post
title:      LessonLearned
subtitle:   
date:       2018-04-21
author:     Mehaei
header-img: img/post-bg-debug.png
catalog: true
tags:
    - python
---
最近，中兴ZTE违反美国商务部禁令，向伊朗出售敏感技术，被美国下达长达7年的禁止令，教训十分深刻。以诚待人，信守承诺，才能在商业社会站稳脚跟。

还是说说最近自己上的一课吧。上了港台服以后，奇奇怪怪的问题比较多。其中之一是玩家被异常登录了。现象是玩家登录游戏，提示账号被异常登录。这种现象本来应该在玩家顶号操作时，被顶号的设备上出现的。不应该在正在登录的活跃客户端上显示

回顾现在的登录过程，玩家连上游戏后，首先会创建一个session。登录完成后，会产生user挂在session上。最后，会找到对应的agent，在上面建立对应的role。当发生顶号的时候，会调用agent的下线流程，下线完成后，清理session。清理完成后，新玩家再执行正常登录流程

现在的问题是，下线过程中，某一步变得比平常慢非常多，结果踢人卡住了。然后再次登录，又继续走踢人流程，结果变成新用户收到了错误的顶号提示信息。。。

要彻底改掉这个问题，要么将顶号简化，变成只切换fd，不走下线流程；要么加上保护标记，玩家在下线过程里再登录，明确提示正在下线，请稍后再试。目前准备先上一些临时的解决方案，用gm指令清除已登录的标记，让玩家可以正常登，到时候覆盖之前下线存盘的数据就好。

关于某一步登出特别慢的问题，想了一下，大概有两个方向，原因差不多。一个是离线过程里，agent服务要向其他服务发起调用，如果call比较多的话，会多次挂起。每次挂起后，收到返回值，都要重新排到消息队列末尾，如果系统繁忙，这时候需要处理的消息特别多，就会出现下线的函数耗时非常久了。另一个方向，是下线的时候，要向一个热门服务发起调用，这个服务的消息队列非常长，导致响应下线请求很慢。这两个问题都涉及到协程调度的公平问题，某些场景下，协程会出现饥饿（starvation）的情况，得不到调度。如果要搞分优先级的调度，估计会变得很麻烦，这块还要再想想
